---
title: "Pre-Processing Crime Data for Phoenix"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
        theme: simplex 
---

```{r setup, include=FALSE}

knitr::opts_chunk$set( echo = TRUE, 
                      message = FALSE, 
                      warning = FALSE, 
                      fig.width = 12, 
                      fig.height = 10 )

```

<br>

The [Crime Data](https://www.phoenixopendata.com/dataset/crime-data) file from the [data portal](https://www.phoenixopendata.com/) contains incidents reported to the Phoenix Police Department. The city updates the [file]("https://www.phoenixopendata.com/dataset/cc08aace-9ca9-467f-b6c1-f0879ab1a358/resource/0ce3411a-2fc6-4302-a33f-167f68608a20/download/crime-data_crime-data_crimestat.csv") at 11am every day and it contains data beginning November 2015 up to 7 days before the posting date. Before we do anything with it, we need to do some pre-processing. Mainly, cleaning up variables, creating basic objects, and incorporating population data to calculate rates.

<br><br>

## Setup and Loading the Data

<br>

### Preparing the enviornment

First we need to clear the workspace and load the libraries we are going to use.

<br>

```{r}

# clear workspace
rm( list = ls() )


# load libraries
library( dplyr )    # used for wrangling the data
library( tidyr )    # used for wrangling the data
library( openxlsx ) # for opening an excel file
library( here )     # for referencing the local directory


```

<br>

### Loading the data

Next we want to load the data and do some cleaning. The data can be called directly from the website link, [here]("https://www.phoenixopendata.com/dataset/cc08aace-9ca9-467f-b6c1-f0879ab1a358/resource/0ce3411a-2fc6-4302-a33f-167f68608a20/download/crime-data_crime-data_crimestat.csv"). I prefer to download a copy and load it locally so that if I encounter an error when I get a new file, I can keep track of any changes.

<br>

```{r, results="hide"}

# call the file stored in the local directory
loc <- "data/data-raw/crime-data_crime-data_crimestat.csv"
crimeData <- read.csv( here( loc ), as.is = TRUE, header = TRUE )
crimeData <- na.omit( crimeData )

# clean up the dates
date.vec <- strptime( crimeData$OCCURRED.ON, format="%m/%d/%Y %H:%M" )
crimeData$year   <- format( date.vec, format="%Y" )
crimeData$month  <- format( date.vec, format="%B" )
crimeData$day365 <- format( date.vec, format="%j" )
crimeData$week   <- format( date.vec, format="%V" )

# drop cases for the most recent month
crimeData <- crimeData[ ! ( 
  crimeData$month == format( Sys.Date(), format="%B" ) &
    crimeData$year == format( Sys.Date(), format="%Y" ) 
) , ]


```

<br>

## Adjusting for Population

Right now, the `crimeData` object is a list of incidents. When we go to aggregate over months or years, we are going to want to adjust based on population differences. In other words, we will want to calculate the rates (not just examine raw counts).

The rates are computed using population data from the [Census Bureau](https://www.census.gov/topics/population.html). The site lists Excel files with estimates of population for incorporated places. Since this is an .xlxs file, we will use the `openxlxs` package (again, click the "Show" button on the right to see the code for this section).

We will work with two files:

  + Years 2010-2019 for [Arizona](https://www2.census.gov/programs-surveys/popest/tables/2010-2019/cities/totals/SUB-IP-EST2019-ANNRES-04.xlsx)
  
  + Years 2020-2021 for [Arizona](https://www2.census.gov/programs-surveys/popest/tables/2020-2021/cities/totals/SUB-IP-EST2021-POP-04.xlsx) 

Let's pull these estimates in and get the data for Phoenix.

<br>

```{r}

# get years 2016-2019
pop.data.2016.2019 <- read.xlsx(
  "https://www2.census.gov/programs-surveys/popest/tables/2010-2019/cities/totals/SUB-IP-EST2019-ANNRES-04.xlsx",
  colNames = TRUE,
  startRow = 4
)

# find the row with the data for Phoenix
grep("Phoenix", pop.data.2016.2019[,1])

# it is the 55th row in the object
phoenix.pop.2016.2019 <-  pop.data.2016.2019[55,]
phoenix.pop.2016.2019

# we only need the data for 2016-2019
phoenix.pop.2016.2019 <- phoenix.pop.2016.2019[-c(1:9)]
phoenix.pop.2016.2019

# repeat these steps for the 2020-2021 data
pop.data.2020.2021 <- read.xlsx(
  "https://www2.census.gov/programs-surveys/popest/tables/2020-2021/cities/totals/SUB-IP-EST2021-POP-04.xlsx",
  colNames = TRUE,
  startRow = 4
)

# find the row with the data for Phoenix (still the 55th)
grep( "Phoenix", pop.data.2020.2021[,1] )
phoenix.pop.2020.2021 <-  pop.data.2020.2021[55,]
phoenix.pop.2020.2021 <- phoenix.pop.2020.2021[-c(1:2)]

# combine the data into a single object
phoenix.pop <- cbind( phoenix.pop.2016.2019, phoenix.pop.2020.2021 )
phoenix.pop

# missing 2022 and 2023 and 2024
# add the difference for each year until you get the actual demographic data
phoenix.pop$"2022" <- phoenix.pop$"2021" + phoenix.pop$"2021" - phoenix.pop$"2020"
phoenix.pop$"2023" <- phoenix.pop$"2022" + phoenix.pop$"2022" - phoenix.pop$"2021"
phoenix.pop$"2024" <- phoenix.pop$"2023" + phoenix.pop$"2023" - phoenix.pop$"2022"

# now we coerce the data to be numeric to use it below
phoenix.pop.data <- as.numeric( phoenix.pop )
phoenix.pop.data

```

<br>

We now have an object, `phoenix.pop.data` that is the yearly population for Phoenix. Note that the population for 2022-2024 is just an estimate, not that reported to the Census Bureau.

<br>

## Creating Objects

<br>

### Counts

Now that we have the counts pre-processed and the population data, we can build a few objects that we can use for analysis.

<br>

```{r}

# daily count of crimes
crimesByDay <- 
  crimeData %>% 
  select( year, month, day365 ) %>%   
  filter( !is.na( day365 ) ) %>% 
  group_by( year, month, day365 ) %>% 
  summarize( counts = n() ) %>% 
  ungroup() %>% 
  mutate( day.time = seq( 1, length( counts ) ) ) %>% 
  select( counts, day.time ) %>% 
  mutate( days = 
            seq( 
              as.Date( head( strptime( crimeData$OCCURRED.ON, format="%m/%d/%Y %H:%M" ) ) )[1], 
              as.Date( tail( strptime( crimeData$OCCURRED.ON, format="%m/%d/%Y %H:%M" ) ) )[6], 
              length.out = length( counts ) ) ) %>% 
  arrange( day.time )
crimesByDay <- as.data.frame( crimesByDay )

# monthly count of crimes
crimesByMonth <- 
  crimeData %>% 
  select( year, month ) %>%   
  filter( year != 2015 ) %>%  
  filter( !is.na( year ) ) %>% 
  group_by( year, month ) %>% 
  summarize( counts = n() ) %>% 
  spread( year, counts ) %>% 
  arrange( match( month, month.name ) ) %>% 
  select( !month )


# crimes by year
crimesByYear <- 
  crimeData %>% 
  select( year ) %>%   
  filter( year != 2015 ) %>%  
  filter( !is.na( year ) ) %>% 
  group_by( year ) %>% 
  summarize( counts = n() ) 

```

<br>

### Rates

Now we want to create objects that capture the rates.

<br>

```{r}

# crime rate is calculated as the count of 
# crimes divided by the population size, then multiplied by 100,000

crimeRatesMonth <- as.data.frame( crimesByMonth )

for ( i in 1: dim( crimeRatesMonth )[2] ){
  crimeRatesMonth[,i] <- ( crimeRatesMonth[,i] / phoenix.pop.data[i] ) * 100000
}

# calculate the crime rate by year
crimeRatesYear <- as.data.frame( crimesByYear )

for ( i in 1: dim( crimeRatesYear )[1] ){
  crimeRatesYear[i,2] <- ( crimeRatesYear[i,2] / phoenix.pop.data[i] ) * 100000
}

# rename the counts column to be rates
crimeRatesYear <- crimeRatesYear %>%  rename( rates = counts )

```

<br>

## Saving the File

We can now save the objects as a file that can be referenced for analysis on separate pages. 

<br>

```{r}

# save the objects as .rds files

saveRDS( crimeData,       file = here( "data/data-rodeo/crimeData.rds" ) )
saveRDS( crimesByDay,     file = here( "data/data-rodeo/crimesByDay.rds" ) )
saveRDS( crimesByMonth,   file = here( "data/data-rodeo/crimesByMonth.rds" ) )
saveRDS( crimesByYear,    file = here( "data/data-rodeo/crimesByYear.rds" ) )
saveRDS( crimeRatesMonth, file = here( "data/data-rodeo/crimeRatesMonth.rds" ) )
saveRDS( crimeRatesYear,  file = here( "data/data-rodeo/crimeRatesYear.rds" ) )


```

If you look in the [data-rodeo](https://jacobtnyoung.github.io/OpenCrimPhx/data/data-rodeo) folder for the repository, you will see that these files have been added. When I run this script, I have to push these files to the repository. But, we can now reference them using the `readRDS()` function.

<br>

## Next steps...  

Now that the data are pre-processed, we can reference this object when we conduct analyses. Visit the [Crime in Phoenix)](https://jacobtnyoung.github.io/OpenCrimPhx/crime.html) page to see these analyses.  

###

<br>

----

<p align="center">
[Back to Open Criminology Phoenix page](https://jacobtnyoung.github.io/OpenCrimPhx/)
</p>

<br>

***Please*** report any needed corrections to the [Issues](https://github.com/jacobtnyoung/OpenCrimPhx/issues/new) page. Thanks!

<br><br>

###### ***Last updated `r format(Sys.time(), '%d %B, %Y')`***